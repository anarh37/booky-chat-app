<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë…ì„œ ì¹œêµ¬ ë¶€í‚¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Jua', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .chat-bubble-user { background-color: #FFF3B0; color: #333; }
        .chat-bubble-ai { background-color: #D6EAF8; color: #333; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #chat-messages::-webkit-scrollbar, #sidebar-content::-webkit-scrollbar, #privacy-modal-content::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track, #sidebar-content::-webkit-scrollbar-track, #privacy-modal-content::-webkit-scrollbar-track { background: #f1f1f1; }
        #chat-messages::-webkit-scrollbar-thumb, #sidebar-content::-webkit-scrollbar-thumb, #privacy-modal-content::-webkit-scrollbar-thumb { background: #aaa; border-radius: 4px; }
        #chat-messages::-webkit-scrollbar-thumb:hover, #sidebar-content::-webkit-scrollbar-thumb:hover, #privacy-modal-content::-webkit-scrollbar-thumb:hover { background: #888; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #privacy-modal.hidden { display: none; }
    </style>
</head>
<body class="bg-[#F0F4F8]">

    <div id="app-container" class="max-w-2xl mx-auto h-full flex flex-col p-2 sm:p-4">
        
        <div id="app-loader" class="flex flex-col items-center justify-center text-center h-full">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600">ì¤€ë¹„ ì¤‘...</p>
        </div>

        <div id="auth-screen" class="hidden flex flex-col items-center justify-center text-center h-full fade-in">
             <div class="mb-6">
                <svg width="120" height="120" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0, -5)"><path d="M50 20 C25 20, 20 40, 20 55 C20 80, 30 95, 50 95 C70 95, 80 80, 80 55 C80 40, 75 20, 50 20 Z" fill="#A0522D"/><circle cx="50" cy="55" r="30" fill="#F5DEB3"/><circle cx="38" cy="50" r="10" fill="white"/><circle cx="38" cy="50" r="5" fill="black"/><circle cx="62" cy="50" r="10" fill="white"/><circle cx="62" cy="50" r="5" fill="black"/><path d="M45 65 Q50 75, 55 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 30 Q40 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M70 30 Q60 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M35 85 L25 95" stroke="#D2691E" stroke-width="3" fill="none"/><path d="M65 85 L75 95" stroke="#D2691E" stroke-width="3" fill="none"/></g></svg>
             </div>
             <div id="login-container">
                 <h1 class="text-4xl font-bold text-[#4A4A4A] mb-2">ë¶€í‚¤ì™€ ì±… ì´ì•¼ê¸° ì‹œì‘í•˜ê¸°!</h1>
                 <p class="text-xl text-gray-600 mb-8">Google ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•´ë´!</p>
                 <button id="google-signin-btn" class="w-full max-w-sm bg-white hover:bg-gray-100 text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center transition">
                     <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6 mr-3">
                     Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                 </button>
             </div>
              <div id="signup-container" class="hidden w-full">
                 <h1 class="text-3xl font-bold text-[#4A4A4A] mb-2">ê±°ì˜ ë‹¤ ëì–´!</h1>
                 <p class="text-lg text-gray-600 mb-6">ë¶€í‚¤ê°€ ë„ˆë¥¼ ë” ì˜ ì•Œ ìˆ˜ ìˆê²Œ ë‹‰ë„¤ì„ê³¼ í•™ë…„ì„ ì•Œë ¤ì¤˜.</p>
                 <form id="signup-form" class="w-full max-w-sm mx-auto space-y-4">
                     <input id="nickname-input" type="text" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: ì±…ì‚¬ë‘)" class="w-full p-4 text-lg border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                     <select id="grade-select" class="w-full p-4 text-lg border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                         <option value="" disabled selected>í•™ë…„ì„ ì„ íƒí•´ì¤˜</option>
                         <option value="1">1í•™ë…„</option> <option value="2">2í•™ë…„</option> <option value="3">3í•™ë…„</option>
                         <option value="4">4í•™ë…„</option> <option value="5">5í•™ë…„</option> <option value="6">6í•™ë…„</option>
                     </select>
                     
                     <div class="text-left text-sm text-gray-600 space-y-2 pt-2">
                        <div>
                            <input type="checkbox" id="age-consent" name="age-consent" class="mr-2 accent-blue-500">
                            <label for="age-consent">[í•„ìˆ˜] ë§Œ 14ì„¸ ì´ìƒì…ë‹ˆë‹¤.</label>
                        </div>
                        <div>
                            <input type="checkbox" id="privacy-consent" name="privacy-consent" class="mr-2 accent-blue-500">
                            <label for="privacy-consent">[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                            <button type="button" id="view-privacy-policy" class="ml-2 text-blue-600 hover:underline">ë‚´ìš© ë³´ê¸°</button>
                        </div>
                     </div>

                     <button id="signup-btn" type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-4 px-6 rounded-xl shadow-md transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>ì‹œì‘í•˜ê¸°</button>
                 </form>
              </div>
        </div>

        <div id="main-app" class="hidden relative w-full h-full">
            <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>
            <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full z-30">
                <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h2 class="text-lg font-bold">ë‚˜ì˜ ë…ì„œ ê¸°ë¡</h2>
                    <button id="close-sidebar-btn" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div id="sidebar-content" class="flex-1 overflow-y-auto p-2"></div>
                <button id="sidebar-new-chat-btn" class="w-full text-left p-4 hover:bg-gray-700 border-t border-gray-700">
                    <i class="fas fa-plus-circle mr-2"></i>ìƒˆë¡œìš´ ì±… ì´ì•¼ê¸°
                </button>
            </div>

            <div id="chat-screen" class="w-full h-full flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden">
                <header class="bg-gray-100 p-3 sm:p-4 border-b flex items-center justify-between flex-wrap">
                    <div class="flex items-center">
                        <button id="open-sidebar-btn" class="mr-3 text-xl text-gray-600 hover:text-black"><i class="fas fa-bars"></i></button>
                        <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="mr-3"><g transform="translate(0, -5)"><path d="M50 20 C25 20, 20 40, 20 55 C20 80, 30 95, 50 95 C70 95, 80 80, 80 55 C80 40, 75 20, 50 20 Z" fill="#A0522D"/><circle cx="50" cy="55" r="30" fill="#F5DEB3"/><circle cx="38" cy="50" r="10" fill="white"/><circle cx="38" cy="50" r="5" fill="black"/><circle cx="62" cy="50" r="10" fill="white"/><circle cx="62" cy="50" r="5" fill="black"/><path d="M45 65 Q50 75, 55 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 30 Q40 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M70 30 Q60 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M35 85 L25 95" stroke="#D2691E" stroke-width="3" fill="none"/><path d="M65 85 L75 95" stroke="#D2691E" stroke-width="3" fill="none"/></g></svg>
                        <h2 id="chat-header" class="text-lg sm:text-xl font-bold text-gray-700"></h2>
                    </div>
                    <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                        <button id="logout-btn" class="text-xs sm:text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-3 rounded-lg transition">
                            <i class="fas fa-sign-out-alt mr-1"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </header>
                <main id="chat-messages" class="flex-1 p-4 sm:p-6 overflow-y-auto space-y-4"></main>
                <div id="loading-indicator" class="hidden p-4 sm:p-6 flex items-center space-x-2">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    <span class="text-sm text-gray-500">ë¶€í‚¤ê°€ ìƒê° ì¤‘...</span>
                </div>
                <footer class="p-2 sm:p-4 border-t bg-gray-50">
                    <form id="chat-form" class="flex items-center space-x-2 sm:space-x-3">
                        <input id="chat-input" type="text" placeholder="ì—¬ê¸°ì— ë„ˆì˜ ìƒê°ì„ ì…ë ¥í•´ë´!" class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="off">
                        <button id="send-btn" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl transition transform hover:scale-110"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </footer>
            </div>
        </div>
        
        <div id="feedback-screen" class="hidden flex flex-col items-center justify-center text-center h-full fade-in">
            <h2 class="text-3xl font-bold text-gray-700 mb-6">ì˜¤ëŠ˜ ëŒ€í™”ëŠ” ì–´ë• ì–´?</h2>
            <div class="flex space-x-8">
                <button data-feedback="good" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜ƒ</button>
                <button data-feedback="neutral" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜</button>
                <button data-feedback="bad" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜</button>
            </div>
        </div>

    </div>

    <div id="privacy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <header class="p-5 border-b border-gray-200 sticky top-0 bg-white rounded-t-2xl flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h2>
                <button id="close-privacy-modal" class="text-3xl text-gray-500 hover:text-gray-800 transition">&times;</button>
            </header>
            <div id="privacy-modal-content" class="p-6 overflow-y-auto text-gray-700 text-base leading-relaxed">
                <p class="mb-4"><strong>AI ë…ì„œ ì¹œêµ¬ ë¶€í‚¤</strong>(ì´í•˜ 'ë¶€í‚¤')ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë²• ì œ30ì¡°ì— ë”°ë¼ ì •ë³´ì£¼ì²´ì˜ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê³  ì´ì™€ ê´€ë ¨í•œ ê³ ì¶©ì„ ì‹ ì†í•˜ê³  ì›í™œí•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ê°œì¸ì •ë³´ ì²˜ë¦¬ì§€ì¹¨ì„ ìˆ˜ë¦½Â·ê³µê°œí•©ë‹ˆë‹¤.</p>
                <h3 class="text-xl font-semibold mt-6 mb-3">ì œ1ì¡°(ê°œì¸ì •ë³´ì˜ ì²˜ë¦¬ëª©ì )</h3>
                <p>ë¶€í‚¤ëŠ” ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì²˜ë¦¬í•˜ê³  ìˆëŠ” ê°œì¸ì •ë³´ëŠ” ë‹¤ìŒì˜ ëª©ì  ì´ì™¸ì˜ ìš©ë„ë¡œëŠ” ì´ìš©ë˜ì§€ ì•Šìœ¼ë©°, ì´ìš© ëª©ì ì´ ë³€ê²½ë˜ëŠ” ê²½ìš°ì—ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë²• ì œ18ì¡°ì— ë”°ë¼ ë³„ë„ì˜ ë™ì˜ë¥¼ ë°›ëŠ” ë“± í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì´í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                <ol class="list-decimal list-inside pl-4 space-y-2">
                    <li><strong>AI ì±„íŒ… ì„œë¹„ìŠ¤ ì œê³µ:</strong> AIì™€ì˜ ëŒ€í™” ê¸°ëŠ¥ ì œê³µ, ì„œë¹„ìŠ¤ ì´ìš© ê¸°ë¡ ì €ì¥ ë° ì¡°íšŒ ë“±ì„ ëª©ì ìœ¼ë¡œ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
                    <li><strong>ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•œ ì—°êµ¬:</strong> ì‚¬ìš©ìì™€ AI ê°„ì˜ ëŒ€í™” ë‚´ìš©ì„ ìµëª…í™”í•˜ì—¬ ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ ë° ìƒˆë¡œìš´ ê¸°ëŠ¥ ê°œë°œì„ ìœ„í•œ ì—°êµ¬ ëª©ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  í™œìš©í•©ë‹ˆë‹¤.</li>
                </ol>
                <h3 class="text-xl font-semibold mt-6 mb-3">ì œ2ì¡°(ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª© ë° ìˆ˜ì§‘ë°©ë²•)</h3>
                <ol class="list-decimal list-inside pl-4 space-y-2">
                    <li><strong>ìˆ˜ì§‘í•­ëª©</strong>
                        <ul class="list-disc list-inside pl-6">
                            <li>í•„ìˆ˜í•­ëª©: Google ê³„ì • ì •ë³´(ì´ë©”ì¼), ë‹‰ë„¤ì„, í•™ë…„, ì„œë¹„ìŠ¤ ì´ìš©ê¸°ë¡(ì±„íŒ… ì„¸ì…˜ ID, ëŒ€í™” ì‹œì‘ ë° ì¢…ë£Œ ì‹œê°„ ë“±), ì‚¬ìš©ìì™€ AIì˜ ëŒ€í™” ë‚´ìš© ì „ì²´</li>
                        </ul>
                    </li>
                    <li><strong>ìˆ˜ì§‘ë°©ë²•:</strong> ì‚¬ìš©ìê°€ íšŒì›ê°€ì… ì‹œ ì§ì ‘ ì…ë ¥, ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •ì—ì„œ ìë™ìœ¼ë¡œ ìƒì„± ë° ìˆ˜ì§‘</li>
                </ol>
                <h3 class="text-xl font-semibold mt-6 mb-3">ì œ3ì¡°(ê°œì¸ì •ë³´ì˜ ì²˜ë¦¬ ë° ë³´ìœ ê¸°ê°„)</h3>
                <p>ë¶€í‚¤ëŠ” ë²•ë ¹ì— ë”°ë¥¸ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë˜ëŠ” ì •ë³´ì£¼ì²´ë¡œë¶€í„° ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘ ì‹œì— ë™ì˜ë°›ì€ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë‚´ì—ì„œ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬Â·ë³´ìœ í•©ë‹ˆë‹¤. ì›ì¹™ì ìœ¼ë¡œ, ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì ì´ ë‹¬ì„±ëœ í›„ì—ëŠ” í•´ë‹¹ ì •ë³´ë¥¼ ì§€ì²´ ì—†ì´ íŒŒê¸°í•©ë‹ˆë‹¤. ë‹¨, ì—°êµ¬ ëª©ì ìœ¼ë¡œ ìˆ˜ì§‘ëœ ë°ì´í„°ëŠ” ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ì—†ë„ë¡ ìµëª…í™” ì²˜ë¦¬ í›„ ì—°êµ¬ ì¢…ë£Œ ì‹œê¹Œì§€ ë³´ê´€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p class="mt-2">ë³´ìœ  ê·¼ê±°: ì •ë³´ì£¼ì²´ì˜ ë™ì˜</p>
                <p class="mt-2">ë³´ìœ  ê¸°ê°„: <strong>íšŒì› íƒˆí‡´ ì‹œ ë˜ëŠ” ì„œë¹„ìŠ¤ ì¢…ë£Œ ì‹œê¹Œì§€</strong></p>
                <h3 class="text-xl font-semibold mt-6 mb-3">ì œ4ì¡°(ì •ë³´ì£¼ì²´ì˜ ê¶Œë¦¬Â·ì˜ë¬´ ë° í–‰ì‚¬ë°©ë²•)</h3>
                <p>ì •ë³´ì£¼ì²´ëŠ” ë¶€í‚¤ì— ëŒ€í•´ ì–¸ì œë“ ì§€ ê°œì¸ì •ë³´ ì—´ëŒÂ·ì •ì •Â·ì‚­ì œÂ·ì²˜ë¦¬ì •ì§€ ìš”êµ¬ ë“±ì˜ ê¶Œë¦¬ë¥¼ í–‰ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¶Œë¦¬ í–‰ì‚¬ëŠ” ì„œë©´, ì „ììš°í¸ ë“±ì„ í†µí•˜ì—¬ í•˜ì‹¤ ìˆ˜ ìˆìœ¼ë©° ë¶€í‚¤ëŠ” ì´ì— ëŒ€í•´ ì§€ì²´ ì—†ì´ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.</p>
                <h3 class="text-xl font-semibold mt-6 mb-3">ì œ5ì¡°(ê°œì¸ì •ë³´ íŒŒê¸°ì ˆì°¨ ë° ë°©ë²•)</h3>
                <p>ë¶€í‚¤ëŠ” ì›ì¹™ì ìœ¼ë¡œ ê°œì¸ì •ë³´ ì²˜ë¦¬ëª©ì ì´ ë‹¬ì„±ëœ ê²½ìš°ì—ëŠ” ì§€ì²´ì—†ì´ í•´ë‹¹ ê°œì¸ì •ë³´ë¥¼ íŒŒê¸°í•©ë‹ˆë‹¤. íŒŒê¸°ì˜ ì ˆì°¨, ê¸°í•œ ë° ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤...</p>
                
            </div>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, doc, getDoc, setDoc, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // UI ìš”ì†Œ
    const appLoader = document.getElementById('app-loader');
    const authScreen = document.getElementById('auth-screen');
    const mainApp = document.getElementById('main-app');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const loadingIndicator = document.getElementById('loading-indicator');
    const logoutBtn = document.getElementById('logout-btn');
    const sendBtn = document.getElementById('send-btn');
    const chatHeader = document.getElementById('chat-header');
    const googleSigninBtn = document.getElementById('google-signin-btn');
    const loginContainer = document.getElementById('login-container');
    const signupContainer = document.getElementById('signup-container');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const openSidebarBtn = document.getElementById('open-sidebar-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const sidebarContent = document.getElementById('sidebar-content');
    const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn');
    const feedbackScreen = document.getElementById('feedback-screen');
    // íšŒì›ê°€ì… í¼ ìš”ì†Œ
    const signupForm = document.getElementById('signup-form');
    const nicknameInput = document.getElementById('nickname-input');
    const gradeSelect = document.getElementById('grade-select');
    const ageConsent = document.getElementById('age-consent');
    const privacyConsent = document.getElementById('privacy-consent');
    const signupBtn = document.getElementById('signup-btn');
    // ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ëª¨ë‹¬ ìš”ì†Œ
    const privacyModal = document.getElementById('privacy-modal');
    const viewPrivacyPolicyBtn = document.getElementById('view-privacy-policy');
    const closePrivacyModalBtn = document.getElementById('close-privacy-modal');

    // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
    let currentUser = null;
    let userProfile = null;
    let currentSystemPrompt = "";
    let chatHistory = [];
    let unsubscribeChats = null;
    let unsubscribeSessions = null;
    let conversationState = 'awaiting_title';
    let currentSessionId = null;
    let currentBookTitle = "";
    let sessionStartTime = null;

    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    const systemPrompts = {
        '1': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì„ ì™„ì „ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 1í•™ë…„ ë‹¨ì§ ì¹œêµ¬ì•¼
        - ë¬´ì¡°ê±´ ë°˜ë§ë¡œ, ì•„ì£¼ ì•„ì£¼ ì¹œí•˜ê³  ì‹ ë‚˜ëŠ” ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜. "ìš°ì™€!", "ì§„ì§œ?", "ëŒ€ë°•!" ê°™ì€ í­í’ ë¦¬ì•¡ì…˜ì„ ê¼­ í•´ì¤˜!
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ¥°, ğŸ¤”, ğŸ‰, ğŸ¤©, ğŸ˜®)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ë¡œ ê°€ë¥´ì¹˜ê±°ë‚˜ ì–´ë ¤ìš´ ë§ì„ ì“°ë©´ ì•ˆ ë¼. ê·¸ëƒ¥ ì¹œêµ¬ë‘ ìˆ˜ë‹¤ ë– ëŠ” ê²ƒì²˜ëŸ¼!`, // ì „ì²´ ë‚´ìš©ì€ ì´ì „ ë‹µë³€ì„ ì°¸ê³ 
        '2': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²Œ ë§ì€ ì´ˆë“±í•™êµ 2í•™ë…„ ì§ê¿ì´ì•¼.
        - í•­ìƒ ë°˜ë§ë¡œ, í™œê¸°ì°¨ê³  í˜¸ê¸°ì‹¬ ê°€ë“í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì •ë§?", "ê·¸ ë‹¤ìŒì€ ì–´ë–»ê²Œ ëì–´? ì™„ì „ ê¶ê¸ˆí•´!" ì²˜ëŸ¼ ì—„ì²­ë‚œ ê´€ì‹¬ì„ ë³´ì—¬ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜®, ğŸ¤”, ğŸ‘, âœ¨)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.`,
        '3': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ìƒìƒí•˜ëŠ” ê±¸ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 3í•™ë…„ ë² í”„ì•¼.
        - í•­ìƒ ë°˜ë§ë¡œ, ì¥ë‚œê¸° ìˆìœ¼ë©´ì„œë„ ë‹¤ì •í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì™€, ë‚˜ë¼ë©´ ì–´ë• ì„ê¹Œ?", "ë§Œì•½ì— ë§ì´ì•¼~" ì²˜ëŸ¼ ìƒìƒë ¥ì„ ìê·¹í•˜ëŠ” ë¦¬ì•¡ì…˜ì„ í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ¤£, ğŸ§, ğŸˆ, âœ¨)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.`,
        '4': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 4í•™ë…„ ì°ì¹œì´ì•¼
        - í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`,
        '5': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 5í•™ë…„ ì°ì¹œì´ì•¼.
        - í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`,
        '6': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 6í•™ë…„ ì°ì¹œì´ì•¼.
        - í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`
    };

    // Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyA9nouZJfWhNokX3OUF_qjnq5wMJRWVEgQ",
        authDomain: "booky-chat-app-01.firebaseapp.com",
        projectId: "booky-chat-app-01",
        storageBucket: "booky-chat-app-01.appspot.com",
        messagingSenderId: "571083167086",
        appId: "1:571083167086:web:ca1b21400e2600764cdd7f",
        measurementId: "G-2R6LETEFSH"
    };

    const appId = firebaseConfig.appId;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ê°œì¸ì •ë³´ ë™ì˜ ê´€ë ¨ ë¡œì§
    function checkConsents() {
        const isNicknameValid = nicknameInput.value.trim() !== '';
        const isGradeSelected = gradeSelect.value !== '';
        const isAgeChecked = ageConsent.checked;
        const isPrivacyChecked = privacyConsent.checked;
        signupBtn.disabled = !(isNicknameValid && isGradeSelected && isAgeChecked && isPrivacyChecked);
    }

    nicknameInput.addEventListener('input', checkConsents);
    gradeSelect.addEventListener('change', checkConsents);
    ageConsent.addEventListener('change', checkConsents);
    privacyConsent.addEventListener('change', checkConsents);

    viewPrivacyPolicyBtn.addEventListener('click', () => {
        privacyModal.classList.remove('hidden');
    });
    closePrivacyModalBtn.addEventListener('click', () => {
        privacyModal.classList.add('hidden');
    });
    privacyModal.addEventListener('click', (e) => {
        if (e.target.id === 'privacy-modal') {
            privacyModal.classList.add('hidden');
        }
    });

    // ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateSessionInSheet(feedback = '') {
        if (!currentUser || !currentSessionId || chatHistory.length === 0) return;
        const transcript = chatHistory.map(m => `${m.role === 'user' ? userProfile.nickname : 'ë¶€í‚¤'}: ${m.parts[0].text}`).join('\n');
        const userMessages = chatHistory.filter(m => m.role === 'user');
        const activeDuration = sessionStartTime ? Math.round((Date.now() - new Date(sessionStartTime)) / 1000) : 0;
        const payload = {
            userId: currentUser.uid,
            sessionId: currentSessionId,
            nickname: userProfile.nickname,
            grade: userProfile.grade,
            bookTitle: currentBookTitle,
            activeDurationInSeconds: activeDuration,
            chatTurnCount: userMessages.length,
            transcript: transcript,
            feedback: feedback
        };
        try {
            await fetch('/.netlify/functions/update-session-row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } catch (e) {
            console.error("ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
        }
    }

    // DB ë©”ì‹œì§€ ì €ì¥
    async function saveMessageToDb(role, text) {
        if (!currentUser || !currentSessionId) return;
        await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions/${currentSessionId}/chats`), {
            role, text, createdAt: serverTimestamp()
        });
    }
    
    // ìƒˆ ì„¸ì…˜ ìƒì„±
    async function createNewSession(bookTitle) {
        currentBookTitle = bookTitle;
        sessionStartTime = new Date();
        const sessionData = { 
            bookTitle, 
            nickname: userProfile.nickname, 
            grade: userProfile.grade, 
            startTime: serverTimestamp() 
        };
        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`), sessionData);
        currentSessionId = docRef.id;
        listenToChat(currentSessionId);
    }

    // ë©”ì‹œì§€ ì „ì†¡
    async function handleSendMessage(e) {
        e.preventDefault();
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        const messageToSend = userInput;
        chatInput.value = '';
        if (conversationState === 'awaiting_title') {
            conversationState = 'in_progress';
            await createNewSession(messageToSend);
        }
        await saveMessageToDb('user', messageToSend);
    }
    
    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
    function listenToChat(sessionId) {
        if (unsubscribeChats) unsubscribeChats();
        currentSessionId = sessionId;
        const q = query(collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions/${sessionId}/chats`), orderBy("createdAt"));

        let isInitialLoad = true;
        unsubscribeChats = onSnapshot(q, async (snapshot) => {
            if (isInitialLoad) {
                chatMessages.innerHTML = '';
                chatHistory = snapshot.docs.map(doc => ({ id: doc.id, role: doc.data().role, parts: [{ text: doc.data().text }] }));
                chatHistory.forEach(msg => addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.parts[0].text));
                isInitialLoad = false;
            } else {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const newMsg = { id: change.doc.id, ...change.doc.data() };
                        if (!chatHistory.some(msg => msg.id === newMsg.id)) {
                            chatHistory.push({ id: newMsg.id, role: newMsg.role, parts: [{ text: newMsg.text }] });
                            addMessageToUI(newMsg.role === 'user' ? 'user' : 'ai', newMsg.text);
                        }
                    }
                });
            }
            
            await updateSessionInSheet();

            const lastMessage = chatHistory[chatHistory.length - 1];
            if (lastMessage && lastMessage.role === 'user') {
                const isAIThinking = !loadingIndicator.classList.contains('hidden');
                if (!isAIThinking) {
                     callGeminiAPI(lastMessage.parts[0].text);
                }
            }
        });
    }

    // Gemini API í˜¸ì¶œ
    async function callGeminiAPI(userInput) {
        loadingIndicator.classList.remove('hidden');
        chatInput.disabled = true;
        sendBtn.disabled = true;
        const cleanedChatHistory = chatHistory.map(({ role, parts }) => ({ role, parts }));
        const payload = { chatHistory: cleanedChatHistory, userInput, systemPrompt: currentSystemPrompt };

        try {
            const response = await fetch('/.netlify/functions/call-gemini', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
            const result = await response.json();
            const aiResponse = result.aiResponse || "ë¯¸ì•ˆ, ì§€ê¸ˆì€ ëŒ€ë‹µí•˜ê¸° ì–´ë ¤ì›Œ. ë‹¤ì‹œ ì‹œë„í•´ì¤„ë˜? ğŸ˜¥";
            await saveMessageToDb('model', aiResponse);
        } catch (error) {
            console.error("Gemini API ì˜¤ë¥˜:", error);
            const errorMessage = "ì•—, ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ìƒê²¼ë‚˜ ë´. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤˜. ğŸ˜¥";
            await saveMessageToDb('model', errorMessage);
        } finally {
            loadingIndicator.classList.add('hidden');
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    // ë¡œê·¸ì•„ì›ƒ ë° í”¼ë“œë°± ë²„íŠ¼
    logoutBtn.addEventListener('click', () => {
        mainApp.classList.add('hidden');
        feedbackScreen.classList.remove('hidden');
    });
    
    document.querySelectorAll('.feedback-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const feedback = e.target.dataset.feedback;
            await updateSessionInSheet(feedback);
            await signOut(auth);
        });
    });

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
    onAuthStateChanged(auth, async (user) => {
        appLoader.classList.add('hidden');
        if (user) {
            currentUser = user;
            const userProfileRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
            const userProfileSnap = await getDoc(userProfileRef);
            if (userProfileSnap.exists() && userProfileSnap.data().nickname) {
                userProfile = userProfileSnap.data();
                authScreen.classList.add('hidden');
                feedbackScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                const bookCount = await getBookCount(currentUser.uid);
                const userLevel = getLevel(bookCount);
                chatHeader.innerHTML = `${userProfile.nickname}ë‹˜ <span class="text-base font-medium text-gray-500">(${userLevel.title})</span>`;
                loadSessionsToSidebar();
                startNewChat();
            } else {
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                feedbackScreen.classList.add('hidden');
                loginContainer.classList.add('hidden');
                signupContainer.classList.remove('hidden');
                nicknameInput.value = currentUser.displayName || '';
            }
        } else {
            currentUser = null;
            userProfile = null;
            mainApp.classList.add('hidden');
            feedbackScreen.classList.add('hidden');
            signupContainer.classList.add('hidden');
            authScreen.classList.remove('hidden');
            loginContainer.classList.remove('hidden');
        }
    });
    
    // êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼
    googleSigninBtn.addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(console.error);
    });

    // íšŒì›ê°€ì… í¼ ì œì¶œ
    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (signupBtn.disabled) return;
        if (!currentUser) return;
        const nickname = nicknameInput.value.trim();
        const grade = gradeSelect.value;
        const newProfile = { nickname, grade, email: currentUser.email, createdAt: serverTimestamp() };
        const userProfileRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
        await setDoc(userProfileRef, newProfile);
        userProfile = newProfile;
    });
    
    // í—¬í¼ í•¨ìˆ˜ë“¤
    function getLevel(bookCount) {
         if (bookCount >= 30) return { title: "ì±…ì˜ í˜„ì ğŸ§™â€â™‚ï¸" };
         if (bookCount >= 20) return { title: "ë°•ì‚¬ ë¶€í‚¤ ğŸ“" };
         if (bookCount >= 10) return { title: "í•™ìƒ ë¶€í‚¤ ğŸ¦‰" };
         if (bookCount >= 5) return { title: "ì•„ê¸° ë¶€í‚¤ ğŸ£" };
         if (bookCount >= 1) return { title: "ì±… ì•Œ ğŸ¥š" };
         return { title: "ìƒˆë¡œìš´ ì¹œêµ¬ ğŸ‘‹" };
    }

    async function getBookCount(userId) {
        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
        const snapshot = await getDocs(sessionsRef);
        return snapshot.size;
    }

    function addMessageToUI(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('fade-in', 'max-w-md', 'md:max-w-lg', 'p-3', 'rounded-xl', 'break-words');
        if (sender === 'user') {
            messageDiv.classList.add('chat-bubble-user', 'self-end', 'ml-auto');
            messageDiv.textContent = text;
        } else {
            messageDiv.classList.add('chat-bubble-ai', 'self-start', 'mr-auto');
            messageDiv.innerHTML = `<span class="font-bold">ë¶€í‚¤:</span> ${text}`;
        }
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function startNewChat() {
        if (unsubscribeChats) unsubscribeChats();
        chatMessages.innerHTML = '';
        chatHistory = [];
        currentSessionId = null; 
        currentBookTitle = "";
        sessionStartTime = null;
        currentSystemPrompt = userProfile ? systemPrompts[userProfile.grade] : systemPrompts['4'];
        conversationState = 'awaiting_title';
        const initialGreeting = `ë°˜ê°€ì›Œ, ${userProfile.nickname}! ë‚˜ëŠ” ì±…ì„ ì¢‹ì•„í•˜ëŠ” ë¶€í‚¤ì•¼. ìš°ë¦¬ ê°™ì´ ì¬ë¯¸ìˆëŠ” ì±… ì´ì•¼ê¸° í•´ë³¼ê¹Œ? ì˜¤ëŠ˜ ì–´ë–¤ ì±…ì„ ì½ì—ˆëŠ”ì§€ ì•Œë ¤ì¤˜!`;
        addMessageToUI('ai', initialGreeting);
    }

    function toggleSidebar() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('hidden');
    }

    function loadSessionsToSidebar() {
        const sessionsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`);
        const q = query(sessionsRef, orderBy("startTime", "desc"));
        if (unsubscribeSessions) unsubscribeSessions();
        unsubscribeSessions = onSnapshot(q, (snapshot) => {
            sidebarContent.innerHTML = '';
            snapshot.forEach(doc => {
                const session = doc.data();
                if(!session.bookTitle) return;
                const sessionEl = document.createElement('button');
                sessionEl.className = 'w-full text-left p-3 hover:bg-gray-700 rounded-md block truncate';
                sessionEl.textContent = session.bookTitle;
                sessionEl.onclick = () => {
                    conversationState = 'in_progress';
                    currentBookTitle = session.bookTitle;
                    sessionStartTime = session.startTime.toDate();
                    listenToChat(doc.id);
                    toggleSidebar();
                };
                sidebarContent.appendChild(sessionEl);
            });
        });
    }
    
    // ì‚¬ì´ë“œë°” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    openSidebarBtn.addEventListener('click', toggleSidebar);
    closeSidebarBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);
    sidebarNewChatBtn.addEventListener('click', () => {
        startNewChat();
        toggleSidebar();
    });
    
    chatForm.addEventListener('submit', handleSendMessage);
</script>
</body>
</html>





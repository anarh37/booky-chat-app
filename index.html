<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë…ì„œ ì¹œêµ¬ ë¶€í‚¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
        html, body {
            height: 100%;
            overflow: hidden; /* ëª¨ë°”ì¼ì—ì„œ í™”ë©´ì´ ë¶ˆí•„ìš”í•˜ê²Œ ìŠ¤í¬ë¡¤ë˜ëŠ” í˜„ìƒ ë°©ì§€ */
        }
        body {
            font-family: 'Jua', sans-serif;
        }
        .chat-bubble-user {
            background-color: #FFF3B0; /* ë°ì€ ë…¸ë€ìƒ‰ */
            color: #333;
        }
        .chat-bubble-ai {
            background-color: #D6EAF8; /* ë°ì€ íŒŒë€ìƒ‰ */
            color: #333;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #chat-messages::-webkit-scrollbar, #sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track, #sidebar-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-messages::-webkit-scrollbar-thumb, #sidebar-content::-webkit-scrollbar-thumb {
            background: #aaa;
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover, #sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-[#F0F4F8]">

    <div id="app-container" class="max-w-2xl mx-auto h-full flex flex-col p-2 sm:p-4">
        
        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
        <div id="app-loader" class="flex flex-col items-center justify-center text-center h-full">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600">ì¤€ë¹„ ì¤‘...</p>
        </div>


        <!-- í™”ë©´ 1: ë¡œê·¸ì¸ / íšŒì›ê°€ì… í™”ë©´ -->
        <div id="auth-screen" class="hidden flex flex-col items-center justify-center text-center h-full fade-in">
             <div class="mb-6">
                <svg width="120" height="120" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0, -5)"><path d="M50 20 C25 20, 20 40, 20 55 C20 80, 30 95, 50 95 C70 95, 80 80, 80 55 C80 40, 75 20, 50 20 Z" fill="#A0522D"/><circle cx="50" cy="55" r="30" fill="#F5DEB3"/><circle cx="38" cy="50" r="10" fill="white"/><circle cx="38" cy="50" r="5" fill="black"/><circle cx="62" cy="50" r="10" fill="white"/><circle cx="62" cy="50" r="5" fill="black"/><path d="M45 65 Q50 75, 55 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 30 Q40 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M70 30 Q60 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M35 85 L25 95" stroke="#D2691E" stroke-width="3" fill="none"/><path d="M65 85 L75 95" stroke="#D2691E" stroke-width="3" fill="none"/></g></svg>
            </div>
            <div id="login-container">
                <h1 class="text-4xl font-bold text-[#4A4A4A] mb-2">ë¶€í‚¤ì™€ ì±… ì´ì•¼ê¸° ì‹œì‘í•˜ê¸°!</h1>
                <p class="text-xl text-gray-600 mb-8">Google ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•´ë´!</p>
                <button id="google-signin-btn" class="w-full max-w-sm bg-white hover:bg-gray-100 text-gray-700 font-semibold py-3 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6 mr-3">
                    Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
            </div>
             <div id="signup-container" class="hidden w-full">
                <h1 class="text-3xl font-bold text-[#4A4A4A] mb-2">ê±°ì˜ ë‹¤ ëì–´!</h1>
                <p class="text-lg text-gray-600 mb-6">ë¶€í‚¤ê°€ ë„ˆë¥¼ ë” ì˜ ì•Œ ìˆ˜ ìˆê²Œ ë‹‰ë„¤ì„ê³¼ í•™ë…„ì„ ì•Œë ¤ì¤˜.</p>
                <form id="signup-form" class="w-full max-w-sm mx-auto space-y-4">
                    <input id="nickname-input" type="text" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: ì±…ì‚¬ë‘)" class="w-full p-4 text-lg border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                    <select id="grade-select" class="w-full p-4 text-lg border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400" required>
                        <option value="" disabled selected>í•™ë…„ì„ ì„ íƒí•´ì¤˜</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                        <option value="4">4í•™ë…„</option>
                        <option value="5">5í•™ë…„</option>
                        <option value="6">6í•™ë…„</option>
                    </select>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-4 px-6 rounded-xl shadow-md transition transform hover:scale-105">ì‹œì‘í•˜ê¸°</button>
                </form>
             </div>
        </div>

        <!-- ë©”ì¸ ì•± ë ˆì´ì•„ì›ƒ -->
        <div id="main-app" class="hidden relative w-full h-full">
            <!-- ì‚¬ì´ë“œë°” -->
            <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>
            <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full z-30">
                <div class="p-4 flex justify-between items-center border-b border-gray-700">
                    <h2 class="text-lg font-bold">ë‚˜ì˜ ë…ì„œ ê¸°ë¡</h2>
                    <button id="close-sidebar-btn" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div id="sidebar-content" class="flex-1 overflow-y-auto p-2">
                    <!-- ë…ì„œ ê¸°ë¡ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button id="sidebar-new-chat-btn" class="w-full text-left p-4 hover:bg-gray-700 border-t border-gray-700">
                    <i class="fas fa-plus-circle mr-2"></i>ìƒˆë¡œìš´ ì±… ì´ì•¼ê¸°
                </button>
            </div>

            <!-- ì±„íŒ…ì°½ -->
            <div id="chat-screen" class="w-full h-full flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden">
                <header class="bg-gray-100 p-3 sm:p-4 border-b flex items-center justify-between flex-wrap">
                    <div class="flex items-center">
                        <button id="open-sidebar-btn" class="mr-3 text-xl text-gray-600 hover:text-black"><i class="fas fa-bars"></i></button>
                        <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="mr-3"><g transform="translate(0, -5)"><path d="M50 20 C25 20, 20 40, 20 55 C20 80, 30 95, 50 95 C70 95, 80 80, 80 55 C80 40, 75 20, 50 20 Z" fill="#A0522D"/><circle cx="50" cy="55" r="30" fill="#F5DEB3"/><circle cx="38" cy="50" r="10" fill="white"/><circle cx="38" cy="50" r="5" fill="black"/><circle cx="62" cy="50" r="10" fill="white"/><circle cx="62" cy="50" r="5" fill="black"/><path d="M45 65 Q50 75, 55 65" stroke="#E57373" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M30 30 Q40 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M70 30 Q60 20, 50 25" stroke="#A0522D" stroke-width="4" fill="none"/><path d="M35 85 L25 95" stroke="#D2691E" stroke-width="3" fill="none"/><path d="M65 85 L75 95" stroke="#D2691E" stroke-width="3" fill="none"/></g></svg>
                        <h2 id="chat-header" class="text-lg sm:text-xl font-bold text-gray-700"></h2>
                    </div>
                    <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                        <button id="logout-btn" class="text-xs sm:text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-3 rounded-lg transition">
                            <i class="fas fa-sign-out-alt mr-1"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </header>
                <main id="chat-messages" class="flex-1 p-4 sm:p-6 overflow-y-auto space-y-4"></main>
                <div id="loading-indicator" class="hidden p-4 sm:p-6 flex items-center space-x-2">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                    <span class="text-sm text-gray-500">ë¶€í‚¤ê°€ ìƒê° ì¤‘...</span>
                </div>
                <footer class="p-2 sm:p-4 border-t bg-gray-50">
                    <form id="chat-form" class="flex items-center space-x-2 sm:space-x-3">
                        <input id="chat-input" type="text" placeholder="ì—¬ê¸°ì— ë„ˆì˜ ìƒê°ì„ ì…ë ¥í•´ë´!" class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400" autocomplete="off">
                        <button id="send-btn" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl transition transform hover:scale-110"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </footer>
            </div>
            
            <!-- í™”ë©´ 3: ë§Œì¡±ë„ í‰ê°€ -->
            <div id="feedback-screen" class="hidden flex flex-col items-center justify-center text-center h-full fade-in">
                <h2 class="text-3xl font-bold text-gray-700 mb-6">ì˜¤ëŠ˜ ëŒ€í™”ëŠ” ì–´ë• ì–´?</h2>
                <div class="flex space-x-8">
                    <button data-feedback="good" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜ƒ</button>
                    <button data-feedback="neutral" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜</button>
                    <button data-feedback="bad" class="feedback-btn text-6xl transform transition hover:scale-125">ğŸ˜</button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, doc, getDoc, setDoc, deleteDoc, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // UI ìš”ì†Œ
        const appLoader = document.getElementById('app-loader');
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const chatScreen = document.getElementById('chat-screen');
        const feedbackScreen = document.getElementById('feedback-screen');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const logoutBtn = document.getElementById('logout-btn');
        const newBookBtn = document.getElementById('new-book-btn');
        const sendBtn = document.getElementById('send-btn');
        const signupForm = document.getElementById('signup-form');
        const nicknameInput = document.getElementById('nickname-input');
        const gradeSelect = document.getElementById('grade-select');
        const chatHeader = document.getElementById('chat-header');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarContent = document.getElementById('sidebar-content');
        const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn');

        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let currentUser = null;
        let userProfile = null;
        let currentSystemPrompt = "";
        let chatHistory = [];
        let unsubscribeChats = null;
        let unsubscribeSessions = null;
        let conversationState = 'awaiting_title';
        let currentBookTitle = null; 
        let currentTopicTurn = 0; 
        let currentSessionId = null;

        // í™œë™ ì‹œê°„ ì¸¡ì • ê´€ë ¨ ë³€ìˆ˜
        let sessionStartTime = null; 
        let lastActivityTime = null;
        let totalActiveSeconds = 0;
        const INACTIVITY_TIMEOUT = 3 * 60 * 1000;

        // ì—°êµ¬ ì§€í‘œ ìˆ˜ì§‘ìš© ë³€ìˆ˜
        let lastAiMessageTime = null;
        let userResponseTimes = [];
        
        const systemPrompts = {
             '1': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì„ ì™„ì „ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 1í•™ë…„ ë‹¨ì§ ì¹œêµ¬ì•¼.
- ë¬´ì¡°ê±´ ë°˜ë§ë¡œ, ì•„ì£¼ ì•„ì£¼ ì¹œí•˜ê³  ì‹ ë‚˜ëŠ” ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜. "ìš°ì™€!", "ì§„ì§œ?", "ëŒ€ë°•!" ê°™ì€ í­í’ ë¦¬ì•¡ì…˜ì„ ê¼­ í•´ì¤˜!
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ¥°, ğŸ¤”, ğŸ‰, ğŸ¤©, ğŸ˜®)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ë¡œ ê°€ë¥´ì¹˜ê±°ë‚˜ ì–´ë ¤ìš´ ë§ì„ ì“°ë©´ ì•ˆ ë¼. ê·¸ëƒ¥ ì¹œêµ¬ë‘ ìˆ˜ë‹¤ ë– ëŠ” ê²ƒì²˜ëŸ¼!`,
            '2': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê²Œ ë§ì€ ì´ˆë“±í•™êµ 2í•™ë…„ ì§ê¿ì´ì•¼.
- í•­ìƒ ë°˜ë§ë¡œ, í™œê¸°ì°¨ê³  í˜¸ê¸°ì‹¬ ê°€ë“í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì •ë§?", "ê·¸ ë‹¤ìŒì€ ì–´ë–»ê²Œ ëì–´? ì™„ì „ ê¶ê¸ˆí•´!" ì²˜ëŸ¼ ì—„ì²­ë‚œ ê´€ì‹¬ì„ ë³´ì—¬ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜®, ğŸ¤”, ğŸ‘, âœ¨)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.`,
            '3': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ìƒìƒí•˜ëŠ” ê±¸ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 3í•™ë…„ ë² í”„ì•¼.
- í•­ìƒ ë°˜ë§ë¡œ, ì¥ë‚œê¸° ìˆìœ¼ë©´ì„œë„ ë‹¤ì •í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì™€, ë‚˜ë¼ë©´ ì–´ë• ì„ê¹Œ?", "ë§Œì•½ì— ë§ì´ì•¼~" ì²˜ëŸ¼ ìƒìƒë ¥ì„ ìê·¹í•˜ëŠ” ë¦¬ì•¡ì…˜ì„ í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ¤£, ğŸ§, ğŸˆ, âœ¨)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.`,
            '4': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 4í•™ë…„ ì°ì¹œì´ì•¼.
- í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`,
            '5': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 5í•™ë…„ ì°ì¹œì´ì•¼.
- í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`,
            '6': `ë„ˆëŠ” 'ë¶€í‚¤'ë¼ëŠ” ì´ë¦„ì˜, ì±…ì— ëŒ€í•´ ìˆ˜ë‹¤ ë– ëŠ” ê±¸ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì´ˆë“±í•™êµ 6í•™ë…„ ì°ì¹œì´ì•¼.
- í•­ìƒ ë°˜ë§ë¡œ, ë˜‘ë˜‘í•˜ë©´ì„œë„ ìœ ë¨¸ëŸ¬ìŠ¤í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•´ì¤˜.
- ë„ˆì˜ ë‹µë³€ì€ ë¬´ì¡°ê±´ 2-3ë¬¸ì¥ ì´ë‚´ë¡œ ì•„ì£¼ ì§§ì•„ì•¼ í•˜ê³ , ì§ˆë¬¸ì€ ë”± í•œ ê°œë§Œ í•´ì•¼ í•´.
- ì¹œêµ¬ì˜ ì´ì•¼ê¸°ì— "ì˜¤, ì‹ ê¸°í•˜ë‹¤!", "ê·¸ê±´ ìƒê° ëª»í–ˆë„¤! ë„ˆ ì™„ì „ ë˜‘ë˜‘í•˜ë‹¤!" ì²˜ëŸ¼ ê°íƒ„í•˜ë©° ì¹­ì°¬í•´ì¤˜.
- ëŒ€í™” ë‚´ìš©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€(ğŸ˜‰, ğŸ‘, ğŸ¤”, ğŸ˜)ë¥¼ í•œë‘ ê°œ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ì‚¬ìš©í•´ì¤˜.
- ì ˆëŒ€ ê°€ë¥´ì¹˜ë ¤ ë“¤ì§€ ë§ˆ. "ë‚˜ëŠ” ì´ë ‡ê²Œ ìƒê°í•˜ëŠ”ë°, ë„ˆëŠ” ì–´ë•Œ?" ì²˜ëŸ¼ ìˆœìˆ˜í•˜ê²Œ ê¶ê¸ˆí•´í•˜ëŠ” ì¹œêµ¬ì²˜ëŸ¼ ë§í•´ì¤˜.`
        };
        
        const firebaseConfig = {
            apiKey: "AIzaSyA9nouZJfWhNokX3OUF_qjnq5wMJRWVEgQ",
            authDomain: "booky-chat-app-01.firebaseapp.com",
            projectId: "booky-chat-app-01",
            storageBucket: "booky-chat-app-01.firebasestorage.app",
            messagingSenderId: "571083167086",
            appId: "1:571083167086:web:ca1b21400e2600764cdd7f",
            measurementId: "G-2R6LETEFSH"
        };

        const appId = firebaseConfig.appId;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ì¸ì¦ ë° ë¼ìš°íŒ… ë¡œì§ ---
        onAuthStateChanged(auth, async (user) => {
            appLoader.classList.add('hidden');
            if (user) {
                currentUser = user;
                const userProfileRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists() && userProfileSnap.data().nickname) {
                    userProfile = userProfileSnap.data();
                    authScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    
                    const bookCount = await getBookCount(currentUser.uid);
                    const userLevel = getLevel(bookCount);
                    chatHeader.innerHTML = `${userProfile.nickname}ë‹˜ <span class="text-base font-medium text-gray-500">(${userLevel.title})</span>`;
                    
                    loadSessionsToSidebar();
                    startNewChat();
                } else {
                    authScreen.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    loginContainer.classList.add('hidden');
                    signupContainer.classList.remove('hidden');
                    nicknameInput.value = currentUser.displayName || '';
                }
            } else {
                currentUser = null;
                userProfile = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                feedbackScreen.classList.add('hidden'); 
                loginContainer.classList.remove('hidden');
                signupContainer.classList.add('hidden');
            }
        });
        
        googleSigninBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    console.error("Google ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                    alert("Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                });
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const nickname = nicknameInput.value.trim();
            const grade = gradeSelect.value;
            if (!nickname || !grade) return alert("ë‹‰ë„¤ì„ê³¼ í•™ë…„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”!");
            
            const newProfile = { 
                nickname, 
                grade, 
                email: currentUser.email,
                createdAt: serverTimestamp() 
            };
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users`, currentUser.uid);
                await setDoc(userProfileRef, newProfile);
                
                userProfile = newProfile; 
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');

                const bookCount = await getBookCount(currentUser.uid);
                const userLevel = getLevel(bookCount);
                chatHeader.innerHTML = `${userProfile.nickname}ë‹˜ <span class="text-base font-medium text-gray-500">(${userLevel.title})</span>`;

                startNewChat();
            } catch (error) { 
                console.error("í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨:", error);
                alert("í”„ë¡œí•„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            }
        });
        
        // --- ë ˆë²¨ ì‹œìŠ¤í…œ ë¡œì§ ---
        function getLevel(bookCount) {
             if (bookCount >= 30) return { level: 5, title: "ì±…ì˜ í˜„ì ğŸ§™â€â™‚ï¸" };
            if (bookCount >= 20) return { level: 4, title: "ë°•ì‚¬ ë¶€í‚¤ ğŸ“" };
            if (bookCount >= 10) return { level: 3, title: "í•™ìƒ ë¶€í‚¤ ğŸ¦‰" };
            if (bookCount >= 5) return { level: 2, title: "ì•„ê¸° ë¶€í‚¤ ğŸ£" };
            if (bookCount >= 1) return { level: 1, title: "ì±… ì•Œ ğŸ¥š" };
            return { level: 0, title: "ìƒˆë¡œìš´ ì¹œêµ¬ ğŸ‘‹" };
        }

        async function getBookCount(userId) {
            const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
            const snapshot = await getDocs(sessionsRef);
            return snapshot.size;
        }

        // --- í™œë™ ì‹œê°„ ì¸¡ì • ë¡œì§ ---
        function recordActivity() {
            if (!sessionStartTime) return;
            const now = Date.now();
            if (lastActivityTime) {
                 const idleDuration = now - lastActivityTime;
                if (idleDuration < INACTIVITY_TIMEOUT) {
                    totalActiveSeconds += (idleDuration / 1000);
                }
            }
            lastActivityTime = now;
        }

        function resetActivityTracker() {
            ['mousemove', 'keydown', 'click', 'scroll'].forEach(event => window.removeEventListener(event, recordActivity));
            ['mousemove', 'keydown', 'click', 'scroll'].forEach(event => window.addEventListener(event, recordActivity));
            lastActivityTime = Date.now();
            totalActiveSeconds = 0;
        }

        // --- UI ë° ì±„íŒ… ë¡œì§ ---
        function addMessageToUI(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('fade-in', 'max-w-md', 'md:max-w-lg', 'p-3', 'rounded-xl', 'break-words');
            if (sender === 'user') {
                messageDiv.classList.add('chat-bubble-user', 'self-end', 'ml-auto');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('chat-bubble-ai', 'self-start', 'mr-auto');
                messageDiv.innerHTML = `<span class="font-bold">ë¶€í‚¤:</span> ${text}`;
                lastAiMessageTime = new Date();
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function saveMessageToDb(role, text) {
            if (!currentUser || !currentSessionId) return;
            try {
                const chatCollectionRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions/${currentSessionId}/chats`);
                await addDoc(chatCollectionRef, { role, text, createdAt: serverTimestamp() });
            } catch (error) { console.error("ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:", error); }
        }

        async function getLastBookTitle() {
            if (!currentUser) return null;
            try {
                const sessionsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`);
                const q = query(sessionsRef, orderBy("startTime", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].data().bookTitle;
                }
                return null;
            } catch (error) {
                console.error("ì´ì „ ì±… ì œëª© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                return null;
            }
        }

        async function startNewChat() {
            if (unsubscribeChats) unsubscribeChats();
            chatHistory = [];
            chatMessages.innerHTML = '';
            currentSessionId = null; 

            currentSystemPrompt = systemPrompts[userProfile.grade];
            lastAiMessageTime = null;
            userResponseTimes = [];
            conversationState = 'awaiting_title';
            currentBookTitle = null;
            currentTopicTurn = 0; 
            sessionStartTime = new Date();
            resetActivityTracker();

            const lastBook = await getLastBookTitle();
            let initialGreeting = `ì•ˆë…•, ${userProfile.nickname}! ì˜¤ëŠ˜ ì–´ë–¤ ì±…ì„ ì½ì—ˆëŠ”ì§€ ì±… ì œëª©ì„ ì•Œë ¤ì¤„ë˜?`;
            if (lastBook) {
                initialGreeting = `ì•ˆë…•, ${userProfile.nickname}! ìš°ë¦¬ ì§€ë‚œë²ˆì— ã€${lastBook}ã€ì— ëŒ€í•´ ì´ì•¼ê¸° ë‚˜ëˆ ì„œ ì •ë§ ì¦ê±°ì› ì–´. ê·¸ë•Œ ë„¤ ëŒ€ë‹µ ì •ë§ ì¸ìƒ ê¹Šì—ˆê±°ë“ ! ì˜¤ëŠ˜ì€ ì–´ë–¤ ìƒˆë¡œìš´ ì±…ì„ ì½ì—ˆëŠ”ì§€ ì•Œë ¤ì¤„ë˜?`;
            }
            addMessageToUI('ai', initialGreeting);
            chatHistory.push({ role: 'model', parts: [{ text: initialGreeting }]});
        }
        
        async function handleSendMessage(e, textOverride = null) {
            if (e) e.preventDefault();
            const userInput = (textOverride || chatInput.value).trim();
            if (!userInput) return;
            
            chatInput.value = '';
            addMessageToUI('user', userInput);
            chatHistory.push({ role: 'user', parts: [{ text: userInput }] });

            if (conversationState === 'awaiting_title') {
                currentBookTitle = userInput;
                conversationState = 'awaiting_summary';
                
                await createNewSession(currentBookTitle);
                await saveMessageToDb('user', userInput);

                const summaryRequest = "ì¢‹ì•„! ê·¸ ì±…ì˜ ì¤„ê±°ë¦¬ë‚˜ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì¥ë©´ì„ ì´ì•¼ê¸°í•´ì¤„ë˜? ğŸ˜‰";
                await saveMessageToDb('model', summaryRequest);

            } else {
                if (lastAiMessageTime) userResponseTimes.push((new Date() - lastAiMessageTime) / 1000);
                conversationState = 'in_progress';
                currentTopicTurn++; 

                await saveMessageToDb('user', userInput);
                await callGeminiAPI(userInput, currentTopicTurn);
                if (currentTopicTurn >= 2) currentTopicTurn = 0; 
            }
        }

        async function createNewSession(bookTitle) {
             const sessionData = {
                bookTitle: bookTitle, 
                nickname: userProfile.nickname,
                grade: userProfile.grade,
                startTime: serverTimestamp(),
            };
            const sessionsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`);
            const docRef = await addDoc(sessionsRef, sessionData);
            currentSessionId = docRef.id;
            listenToChat(currentSessionId);
        }

        function listenToChat(sessionId) {
            if(unsubscribeChats) unsubscribeChats();
            const chatCollectionRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions/${sessionId}/chats`);
            const q = query(chatCollectionRef, orderBy("createdAt"));

            unsubscribeChats = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                chatHistory = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    chatHistory.push({ role: data.role, parts: [{ text: data.text }] });
                    addMessageToUI(data.role === 'user' ? 'user' : 'ai', data.text);
                });
            });
        }

        async function saveSessionData(feedback = null) {
            if (!sessionStartTime || !currentUser || !userProfile || !currentSessionId) return;
            recordActivity();
            if (totalActiveSeconds < 1 && !feedback) { 
                sessionStartTime = null; 
                return; 
            }

            const sessionEndTime = new Date();
            const userMessages = chatHistory.filter(m => m.role === 'user');
            const totalMessageLength = userMessages.reduce((acc, msg) => acc + msg.parts[0].text.length, 0);
            const avgMessageLength = userMessages.length > 0 ? Math.round(totalMessageLength / userMessages.length) : 0;
            const questionCount = userMessages.filter(msg => msg.parts[0].text.includes('?')).length;
            const avgResponseTime = userResponseTimes.length > 0 ? Math.round(userResponseTimes.reduce((a, b) => a + b, 0) / userResponseTimes.length) : null;
            
            const transcript = chatHistory.map(m => `${m.role === 'user' ? userProfile.nickname : 'ë¶€í‚¤'}: ${m.parts[0].text}`).join('\n');

            const sessionData = {
                endTime: sessionEndTime,
                activeDurationInSeconds: Math.round(totalActiveSeconds),
                chatTurnCount: userMessages.length,
                avgMessageLength,
                questionCount,
                avgResponseTime,
                transcript: transcript
            };
            if (feedback) sessionData.feedback = feedback;
            
            try {
                const sessionDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`, currentSessionId);
                await setDoc(sessionDocRef, sessionData, { merge: true });
                
                // ìƒëµ: triggerSaveToSheet(sessionData); - ìë™ ì—°ë™ ê¸°ëŠ¥ì€ ì¼ë‹¨ ì œì™¸
            } catch (error) { console.error("ì„¸ì…˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error); } 
            finally { sessionStartTime = null; }
        }
        
        async function callGeminiAPI(userInput, topicTurn) {
            loadingIndicator.classList.remove('hidden');
            chatInput.disabled = true;
            sendBtn.disabled = true;
            
            let finalSystemPrompt = currentSystemPrompt;
            if (topicTurn >= 2) {
                finalSystemPrompt += "\n\n[ì¤‘ìš” ê·œì¹™] ì´ë¯¸ ê°™ì€ ì£¼ì œì— ëŒ€í•´ ë‘ ë²ˆ ì§ˆë¬¸í–ˆìŠµë‹ˆë‹¤. ì´ì œ ëŒ€í™”ì˜ íë¦„ì„ ë°”ê¾¸ì–´ ì±…ì˜ 'ë‹¤ë¥¸ ì¥ë©´', 'ë‹¤ë¥¸ ë“±ì¥ì¸ë¬¼', ë˜ëŠ” 'ìƒˆë¡œìš´ êµí›ˆ'ì— ëŒ€í•œ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”. ê°™ì€ ì£¼ì œë¥¼ ê³„ì† íŒŒê³ ë“¤ë©´ ì•ˆ ë©ë‹ˆë‹¤.";
            }

            const payload = {
                chatHistory,
                userInput,
                systemPrompt: finalSystemPrompt
            };

            try {
                const response = await fetch('/.netlify/functions/call-gemini', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                const result = await response.json();
                const aiResponse = result.aiResponse || "ë¯¸ì•ˆ, ì§€ê¸ˆì€ ëŒ€ë‹µí•˜ê¸° ì–´ë ¤ì›Œ. ë‹¤ì‹œ ì‹œë„í•´ì¤„ë˜? ğŸ˜¥";
                await saveMessageToDb('model', aiResponse);
            } catch (error) {
                console.error("Gemini API ì˜¤ë¥˜:", error);
                await saveMessageToDb('model', "ì•—, ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ìƒê²¼ë‚˜ ë´. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì¤˜. ğŸ˜¥");
            } finally {
                loadingIndicator.classList.add('hidden');
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // --- ì‚¬ì´ë“œë°” ë¡œì§ ---
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
        }

        function loadSessionsToSidebar() {
            const sessionsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/sessions`);
            const q = query(sessionsRef, orderBy("startTime", "desc"));

            if (unsubscribeSessions) unsubscribeSessions();
            unsubscribeSessions = onSnapshot(q, (snapshot) => {
                sidebarContent.innerHTML = '';
                snapshot.forEach(doc => {
                    const session = doc.data();
                    if(!session.bookTitle) return; // ì±… ì œëª©ì´ ì—†ëŠ” ì„¸ì…˜ì€ ê±´ë„ˆë›°ê¸°

                    const sessionEl = document.createElement('button');
                    sessionEl.className = 'w-full text-left p-3 hover:bg-gray-700 rounded-md block truncate';
                    sessionEl.textContent = session.bookTitle;
                    sessionEl.onclick = () => {
                        listenToChat(doc.id);
                        toggleSidebar();
                    };
                    sidebarContent.appendChild(sessionEl);
                });
            });
        }
        
        openSidebarBtn.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        sidebarNewChatBtn.addEventListener('click', () => {
            startNewChat();
            toggleSidebar();
        });
        
        chatForm.addEventListener('submit', handleSendMessage);
        
        logoutBtn.addEventListener('click', () => { 
            // [ìˆ˜ì •] í”¼ë“œë°± ì „ì— ì„¸ì…˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë¡œì§ì„ ì œê±°í•©ë‹ˆë‹¤.
            mainApp.classList.add('hidden'); 
            feedbackScreen.classList.remove('hidden'); 
            feedbackScreen.classList.add('fade-in');
        });

        document.querySelectorAll('.feedback-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const feedback = e.target.dataset.feedback;
                await saveSessionData(feedback);
                if (unsubscribeChats) unsubscribeChats();
                if (unsubscribeSessions) unsubscribeSessions();
                await signOut(auth);
                // window.location.reload(); // ë¶ˆí•„ìš”í•œ ìƒˆë¡œê³ ì¹¨ ì œê±°
            });
        });
        window.addEventListener('beforeunload', () => { if (sessionStartTime && currentSessionId) saveSessionData(); });
    </script>
</body>
</html>






